<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eMCP Tool Selector</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .server-section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
        }

        .server-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            cursor: pointer;
        }

        .server-header:hover {
            background: #f9f9f9;
        }

        .expand-toggle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 12px;
            color: #666;
            transition: transform 0.2s;
        }

        .server-section.collapsed .expand-toggle {
            transform: rotate(-90deg);
        }

        .server-section.collapsed .tools-grid {
            display: none;
        }

        .server-section.collapsed .server-header {
            margin-bottom: 0;
            border-bottom: none;
        }

        .server-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .server-count {
            color: #666;
            font-size: 14px;
            margin-right: 15px;
        }

        .select-all-btn {
            padding: 5px 12px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .select-all-btn:hover {
            background: #e0e0e0;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
        }

        .tool-item {
            display: flex;
            align-items: flex-start;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .tool-item:hover {
            background: #f9f9f9;
        }

        .tool-item input[type="checkbox"] {
            margin-right: 10px;
            margin-top: 3px;
            cursor: pointer;
        }

        .tool-label {
            cursor: pointer;
            font-size: 14px;
            color: #333;
            flex: 1;
        }

        .tool-name {
            font-weight: 500;
        }

        .tool-description {
            color: #666;
            font-size: 12px;
            margin-top: 2px;
        }

        .actions {
            position: sticky;
            bottom: 20px;
            background: white;
            padding: 20px;
            border-top: 2px solid #e0e0e0;
            margin: 30px -30px -30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 0 8px 8px;
        }

        .selected-count {
            color: #666;
            font-size: 14px;
        }

        .commit-btn {
            padding: 12px 30px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .commit-btn:hover {
            background: #0056b3;
        }

        .commit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .success {
            background: #efe;
            border: 1px solid #cfc;
            color: #3c3;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .header-row {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .group-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .group-selector label {
            font-weight: 500;
            color: #555;
        }

        .group-selector select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 2px solid #007bff;
            font-size: 14px;
            font-weight: 500;
            min-width: 200px;
        }

        .create-group-btn {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .create-group-btn:hover {
            background: #218838;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            min-width: 400px;
        }

        .modal h3 {
            margin-bottom: 20px;
        }

        .modal input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .modal-actions .cancel-btn {
            background: #6c757d;
            color: white;
        }

        .modal-actions .create-btn {
            background: #28a745;
            color: white;
        }

        .delete-group-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .delete-group-btn:hover {
            background: #c82333;
        }

        .delete-group-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Add Server Button */
        .add-server-btn {
            padding: 8px 16px;
            background: #6f42c1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .add-server-btn:hover {
            background: #5a32a3;
        }

        /* Add Server Modal */
        .add-server-modal {
            min-width: 500px;
            max-width: 600px;
        }

        .add-server-modal .step {
            display: none;
        }

        .add-server-modal .step.active {
            display: block;
        }

        .step-description {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .config-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .config-field {
            margin-bottom: 15px;
        }

        .config-field label {
            display: block;
            font-weight: 500;
            color: #555;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .config-field input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .config-field input:focus {
            border-color: #007bff;
            outline: none;
        }

        .env-vars-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .env-vars-section h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .env-var-input {
            margin-bottom: 10px;
        }

        .env-var-input label {
            display: block;
            font-family: monospace;
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .env-var-input input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .progress-container {
            padding: 20px 0;
        }

        .progress-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            color: #666;
        }

        .progress-item .icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-item.pending .icon::before {
            content: "○";
            color: #ccc;
        }

        .progress-item.active .icon::before {
            content: "◉";
            color: #007bff;
            animation: pulse 1s infinite;
        }

        .progress-item.done .icon::before {
            content: "✓";
            color: #28a745;
        }

        .progress-item.error .icon::before {
            content: "✗";
            color: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .result-success {
            text-align: center;
            padding: 20px;
        }

        .result-success .icon {
            font-size: 48px;
            color: #28a745;
            margin-bottom: 15px;
        }

        .result-error {
            text-align: center;
            padding: 20px;
        }

        .result-error .icon {
            font-size: 48px;
            color: #dc3545;
            margin-bottom: 15px;
        }

        .result-error .error-message {
            color: #dc3545;
            margin-bottom: 15px;
        }

        .modal-actions .back-btn {
            background: #6c757d;
            color: white;
        }

        .modal-actions .next-btn,
        .modal-actions .provision-btn {
            background: #007bff;
            color: white;
        }

        .modal-actions .next-btn:disabled,
        .modal-actions .provision-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .modal-actions .done-btn {
            background: #28a745;
            color: white;
        }

        .infisical-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .detected-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #e9ecef;
            border-radius: 3px;
            font-size: 11px;
            color: #666;
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header-row">
            <h1>eMCP Tool Selector</h1>
            <div class="group-selector">
                <label for="groupSelect">Group:</label>
                <select id="groupSelect" onchange="switchGroup(this.value)">
                    <option value="">Loading...</option>
                </select>
                <button class="create-group-btn" onclick="showCreateGroupModal()">+ New Group</button>
                <button id="deleteGroupBtn" class="delete-group-btn" onclick="deleteCurrentGroup()" disabled>Delete Group</button>
                <button class="add-server-btn" onclick="showAddServerModal()">+ Add MCP Server</button>
            </div>
        </div>
        <p class="subtitle" id="groupEndpoint">Select tools to include in the tool group</p>

        <div style="margin-bottom: 15px; display: flex; gap: 10px;">
            <button onclick="expandAll()" style="padding: 6px 12px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 12px;">▼ Expand All</button>
            <button onclick="collapseAll()" style="padding: 6px 12px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 12px;">▶ Collapse All</button>
        </div>

        <div id="message"></div>
        <div id="loading" class="loading">Loading tools...</div>
        <div id="servers"></div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal-overlay">
        <div class="modal">
            <h3>Create New Group</h3>
            <input type="text" id="newGroupName" placeholder="Group name (e.g., my-project)">
            <input type="text" id="newGroupDescription" placeholder="Description (optional)">
            <div class="modal-actions">
                <button class="cancel-btn" onclick="hideCreateGroupModal()">Cancel</button>
                <button class="create-btn" onclick="createGroup()">Create</button>
            </div>
        </div>
    </div>

    <!-- Add Server Modal -->
    <div id="addServerModal" class="modal-overlay">
        <div class="modal add-server-modal">
            <!-- Step 1: URL Input -->
            <div id="addServerStep1" class="step active">
                <h3>Add MCP Server</h3>
                <p class="step-description">
                    Enter a GitHub repository URL, npm package name, or Docker image reference.
                </p>
                <input type="text" id="serverUrl" placeholder="https://github.com/org/mcp-server or @org/package or ghcr.io/org/image:tag">
                <div class="modal-actions">
                    <button class="cancel-btn" onclick="hideAddServerModal()">Cancel</button>
                    <button class="next-btn" id="detectBtn" onclick="detectServer()">Detect</button>
                </div>
            </div>

            <!-- Step 2: Configuration Review -->
            <div id="addServerStep2" class="step">
                <h3>Configure Server</h3>
                <div id="infisicalWarning" class="infisical-warning" style="display: none;">
                    Infisical is not configured. Secrets will need to be added manually to your .env file.
                </div>
                <div id="detectedConfig" class="config-preview">
                    <!-- Populated dynamically -->
                </div>
                <div id="requiredArgsSection" class="env-vars-section" style="display: none;">
                    <h4>Required Arguments</h4>
                    <p class="step-description">This server requires additional arguments:</p>
                    <div id="requiredArgsInputs">
                        <!-- Dynamic inputs for each required arg -->
                    </div>
                </div>
                <div id="envVarsSection" class="env-vars-section" style="display: none;">
                    <h4>Environment Variables</h4>
                    <p class="step-description">Enter values for required environment variables:</p>
                    <div id="envVarInputs">
                        <!-- Dynamic inputs for each required env var -->
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="back-btn" onclick="showAddServerStep(1)">Back</button>
                    <button class="provision-btn" id="provisionBtn" onclick="provisionServer()">Provision</button>
                </div>
            </div>

            <!-- Step 3: Provisioning Progress -->
            <div id="addServerStep3" class="step">
                <h3>Provisioning Server...</h3>
                <div class="progress-container">
                    <div class="progress-item pending" id="prog-secrets">
                        <span class="icon"></span>
                        <span>Storing secrets...</span>
                    </div>
                    <div class="progress-item pending" id="prog-compose">
                        <span class="icon"></span>
                        <span>Adding to Docker Compose...</span>
                    </div>
                    <div class="progress-item pending" id="prog-config">
                        <span class="icon"></span>
                        <span>Creating MCP config...</span>
                    </div>
                    <div class="progress-item pending" id="prog-start">
                        <span class="icon"></span>
                        <span>Starting container...</span>
                    </div>
                    <div class="progress-item pending" id="prog-verify">
                        <span class="icon"></span>
                        <span>Verifying tools...</span>
                    </div>
                </div>
            </div>

            <!-- Step 4: Result -->
            <div id="addServerStep4" class="step">
                <div id="resultContent">
                    <!-- Populated on success/failure -->
                </div>
                <div class="modal-actions">
                    <button class="done-btn" onclick="hideAddServerModal(); loadTools();">Done</button>
                </div>
            </div>
        </div>
    </div>

        <div class="presets-section"
            style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
            <h3 style="margin-bottom: 15px; color: #333;">Presets</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                <select id="presetSelect"
                    style="padding: 10px; border-radius: 4px; border: 1px solid #ced4da; flex: 1; font-size: 14px;">
                    <option value="">Select a preset...</option>
                </select>
                <button onclick="loadPreset()"
                    style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Load</button>
                <button onclick="deletePreset()"
                    style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Delete</button>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="newPresetName" placeholder="New preset name"
                    style="padding: 10px; border-radius: 4px; border: 1px solid #ced4da; flex: 1; font-size: 14px;">
                <button onclick="savePreset()"
                    style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Save
                    Selection as Preset</button>
            </div>
        </div>

        <!-- MCP Servers Section -->
        <div id="serversSection" class="presets-section"
            style="margin-top: 30px; padding: 20px; background: #f3e8ff; border-radius: 8px; border: 1px solid #d8b4fe;">
            <h3 style="margin-bottom: 15px; color: #6b21a8;">MCP Servers</h3>
            <p style="font-size: 13px; color: #7c3aed; margin-bottom: 15px;">
                Manage MCP server containers. Restart or remove servers as needed.
            </p>
            <div id="serversList">
                <!-- Populated dynamically -->
            </div>
        </div>

        <div id="actions" class="actions" style="display: none;">
            <div class="selected-count">
                <strong><span id="selectedCount">0</span></strong> tools selected
            </div>
            <button id="commitBtn" class="commit-btn">Update eMCP Group</button>
        </div>
    </div>

    <script>
        let allTools = {};
        let currentGroup = null;
        let defaultGroup = null;

        // =====================================================================
        // Group Management
        // =====================================================================

        async function loadGroups() {
            try {
                const response = await fetch('/api/groups');
                if (!response.ok) throw new Error('Failed to fetch groups');

                const data = await response.json();
                if (!data.success) throw new Error(data.error);

                defaultGroup = data.default;
                const select = document.getElementById('groupSelect');
                select.innerHTML = '';

                data.groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group + (group === defaultGroup ? ' (default)' : '');
                    select.appendChild(option);
                });

                // Select default group initially
                currentGroup = defaultGroup;
                select.value = currentGroup;
                updateGroupUI();

                return data.groups;
            } catch (error) {
                showMessage('Error loading groups: ' + error.message, 'error');
                return [];
            }
        }

        function switchGroup(groupName) {
            if (!groupName) return;
            currentGroup = groupName;
            updateGroupUI();
            loadCurrentSelection();
        }

        function updateGroupUI() {
            // Update subtitle with endpoint URL
            document.getElementById('groupEndpoint').textContent =
                `MCP endpoint: /v0/groups/${currentGroup}/mcp`;

            // Update button text
            document.getElementById('commitBtn').textContent = `Update ${currentGroup} Group`;

            // Enable/disable delete button (can't delete default group)
            const deleteBtn = document.getElementById('deleteGroupBtn');
            deleteBtn.disabled = (currentGroup === defaultGroup);
        }

        function showCreateGroupModal() {
            document.getElementById('createGroupModal').classList.add('active');
            document.getElementById('newGroupName').focus();
        }

        function hideCreateGroupModal() {
            document.getElementById('createGroupModal').classList.remove('active');
            document.getElementById('newGroupName').value = '';
            document.getElementById('newGroupDescription').value = '';
        }

        async function createGroup() {
            const name = document.getElementById('newGroupName').value.trim();
            const description = document.getElementById('newGroupDescription').value.trim();

            if (!name) {
                showMessage('Please enter a group name', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/groups/${encodeURIComponent(name)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: description || undefined })
                });

                const data = await response.json();
                if (!data.success) throw new Error(data.error);

                hideCreateGroupModal();
                showMessage(`Group '${name}' created`, 'success');

                // Reload groups and switch to new one
                await loadGroups();
                document.getElementById('groupSelect').value = name;
                switchGroup(name);
            } catch (error) {
                showMessage('Error creating group: ' + error.message, 'error');
            }
        }

        async function deleteCurrentGroup() {
            if (currentGroup === defaultGroup) {
                showMessage('Cannot delete the default group', 'error');
                return;
            }

            if (!confirm(`Delete group '${currentGroup}'? This cannot be undone.`)) return;

            try {
                const response = await fetch(`/api/groups/${encodeURIComponent(currentGroup)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (!data.success) throw new Error(data.error);

                showMessage(`Group '${currentGroup}' deleted`, 'success');

                // Switch back to default and reload
                await loadGroups();
            } catch (error) {
                showMessage('Error deleting group: ' + error.message, 'error');
            }
        }

        // =====================================================================
        // Tool Loading
        // =====================================================================

        async function loadTools() {
            try {
                // Load groups first
                await loadGroups();

                const response = await fetch('/api/tools');
                if (!response.ok) throw new Error('Failed to fetch tools');

                const data = await response.json();
                allTools = data.servers;

                renderTools();
                collapseAllServers();
                await loadCurrentSelection();
                expandServersWithActiveTools();
                loadPresets();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('actions').style.display = 'flex';
            } catch (error) {
                showMessage('Error loading tools: ' + error.message, 'error');
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderTools() {
            const container = document.getElementById('servers');
            container.innerHTML = '';

            for (const [serverName, tools] of Object.entries(allTools)) {
                const section = document.createElement('div');
                section.className = 'server-section';
                section.dataset.server = serverName;

                const header = document.createElement('div');
                header.className = 'server-header';
                header.innerHTML = `
                    <div class="expand-toggle">▼</div>
                    <div class="server-name">${serverName}</div>
                    <div class="server-count">${tools.length} tools</div>
                    <button class="select-all-btn" onclick="event.stopPropagation(); toggleServer('${serverName}')">Select All</button>
                `;
                header.onclick = (e) => {
                    if (e.target.classList.contains('select-all-btn')) return;
                    toggleExpand(serverName);
                };
                section.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'tools-grid';

                tools.forEach(tool => {
                    const item = document.createElement('div');
                    item.className = 'tool-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `tool-${tool.name}`;
                    checkbox.value = tool.name;
                    checkbox.onchange = updateCount;

                    const label = document.createElement('label');
                    label.className = 'tool-label';
                    label.htmlFor = `tool-${tool.name}`;
                    label.innerHTML = `
                        <div class="tool-name">${tool.name.replace(serverName + '__', '')}</div>
                        ${tool.description ? `<div class="tool-description">${tool.description}</div>` : ''}
                    `;

                    item.appendChild(checkbox);
                    item.appendChild(label);
                    grid.appendChild(item);
                });

                section.appendChild(grid);
                container.appendChild(section);
            }
        }

        function toggleServer(serverName) {
            const section = document.querySelector(`[data-server="${serverName}"]`);
            const checkboxes = section.querySelectorAll('input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(cb => cb.checked = !allChecked);
            updateCount();
        }

        function toggleExpand(serverName) {
            const section = document.querySelector(`[data-server="${serverName}"]`);
            section.classList.toggle('collapsed');
            saveExpandState();
        }

        function expandAll() {
            document.querySelectorAll('.server-section').forEach(s => s.classList.remove('collapsed'));
            saveExpandState();
        }

        function collapseAll() {
            document.querySelectorAll('.server-section').forEach(s => s.classList.add('collapsed'));
            saveExpandState();
        }

        function saveExpandState() {
            // No longer persisting - expand state is based on active tools
        }

        function collapseAllServers() {
            document.querySelectorAll('.server-section').forEach(s => s.classList.add('collapsed'));
        }

        function expandServersWithActiveTools() {
            document.querySelectorAll('.server-section').forEach(section => {
                const hasChecked = section.querySelector('input[type="checkbox"]:checked');
                if (hasChecked) {
                    section.classList.remove('collapsed');
                }
            });
        }

        function updateCount() {
            const checked = document.querySelectorAll('input[type="checkbox"]:checked');
            document.getElementById('selectedCount').textContent = checked.length;
        }

        function getSelectedTools() {
            const checked = document.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checked).map(cb => cb.value);
        }

        async function loadCurrentSelection() {
            try {
                const response = await fetch(`/api/groups/${encodeURIComponent(currentGroup)}/tools`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.tools) {
                        // Clear all first
                        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

                        // Check active tools
                        data.tools.forEach(toolName => {
                            const checkbox = document.getElementById(`tool-${toolName}`);
                            if (checkbox) checkbox.checked = true;
                        });
                        updateCount();
                    }
                }
            } catch (e) {
                console.error('Failed to load current selection', e);
            }
        }

        async function loadPresets() {
            try {
                const response = await fetch('/api/presets');
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('presetSelect');
                    select.innerHTML = '<option value="">Select a preset...</option>';

                    if (data.success && data.presets) {
                        data.presets.forEach(preset => {
                            const option = document.createElement('option');
                            option.value = preset;
                            option.textContent = preset;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (e) {
                console.error('Failed to load presets', e);
            }
        }

        async function savePreset() {
            const name = document.getElementById('newPresetName').value.trim();
            if (!name) {
                showMessage('Please enter a preset name', 'error');
                return;
            }

            const selected = getSelectedTools();
            if (selected.length === 0) {
                showMessage('Please select at least one tool', 'error');
                return;
            }

            try {
                const response = await fetch('/api/presets/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, tools: selected })
                });

                const data = await response.json();
                if (data.success) {
                    showMessage(`Preset '${data.name}' saved`, 'success');
                    document.getElementById('newPresetName').value = '';
                    loadPresets(); // Refresh list
                } else {
                    showMessage('Error saving preset: ' + data.error, 'error');
                }
            } catch (e) {
                showMessage('Error saving preset: ' + e.message, 'error');
            }
        }

        async function loadPreset() {
            const name = document.getElementById('presetSelect').value;
            if (!name) return;

            if (!confirm(`Load preset '${name}'? This will update the active tool group immediately.`)) return;

            try {
                const response = await fetch('/api/presets/load', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });

                const data = await response.json();
                if (data.success) {
                    showMessage(`Loaded preset '${name}'`, 'success');
                    // Refresh checkboxes
                    loadCurrentSelection();
                } else {
                    showMessage('Error loading preset: ' + data.error, 'error');
                }
            } catch (e) {
                showMessage('Error loading preset: ' + e.message, 'error');
            }
        }

        async function deletePreset() {
            const name = document.getElementById('presetSelect').value;
            if (!name) return;

            if (!confirm(`Delete preset '${name}'?`)) return;

            try {
                const response = await fetch('/api/presets/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });

                const data = await response.json();
                if (data.success) {
                    showMessage(`Preset '${name}' deleted`, 'success');
                    loadPresets(); // Refresh list
                } else {
                    showMessage('Error deleting preset: ' + data.error, 'error');
                }
            } catch (e) {
                showMessage('Error deleting preset: ' + e.message, 'error');
            }
        }

        async function commitSelection() {
            const selected = getSelectedTools();
            const btn = document.getElementById('commitBtn');
            const originalText = btn.textContent;

            btn.disabled = true;
            btn.textContent = 'Updating...';

            try {
                const response = await fetch(`/api/groups/${encodeURIComponent(currentGroup)}/tools`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tools: selected })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Update failed');
                }

                const result = await response.json();
                showMessage(`Successfully updated '${currentGroup}' group with ${selected.length} tools`, 'success');
            } catch (error) {
                showMessage('Error updating group: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.className = type;
            msgDiv.textContent = text;
            msgDiv.style.display = 'block';

            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 5000);
        }

        document.getElementById('commitBtn').addEventListener('click', commitSelection);

        // =====================================================================
        // Add Server Functions
        // =====================================================================

        let detectedServerConfig = null;
        let infisicalConfigured = false;

        async function checkInfisicalStatus() {
            try {
                const response = await fetch('/api/servers/infisical-status');
                const data = await response.json();
                infisicalConfigured = data.configured;
            } catch (e) {
                infisicalConfigured = false;
            }
        }

        function showAddServerModal() {
            checkInfisicalStatus();
            document.getElementById('addServerModal').classList.add('active');
            document.getElementById('serverUrl').value = '';
            document.getElementById('serverUrl').focus();
            showAddServerStep(1);
            resetProgressIndicators();
        }

        function hideAddServerModal() {
            document.getElementById('addServerModal').classList.remove('active');
            detectedServerConfig = null;
        }

        function showAddServerStep(step) {
            document.querySelectorAll('#addServerModal .step').forEach(s => s.classList.remove('active'));
            document.getElementById(`addServerStep${step}`).classList.add('active');
        }

        function resetProgressIndicators() {
            ['prog-secrets', 'prog-compose', 'prog-config', 'prog-start', 'prog-verify'].forEach(id => {
                const el = document.getElementById(id);
                el.className = 'progress-item pending';
            });
        }

        function setProgressState(id, state) {
            const el = document.getElementById(id);
            el.className = `progress-item ${state}`;
        }

        async function detectServer() {
            const url = document.getElementById('serverUrl').value.trim();
            if (!url) {
                showMessage('Please enter a URL or package name', 'error');
                return;
            }

            const btn = document.getElementById('detectBtn');
            btn.disabled = true;
            btn.textContent = 'Detecting...';

            try {
                const response = await fetch('/api/servers/detect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const data = await response.json();
                if (!data.success) throw new Error(data.error);

                detectedServerConfig = data.detected;
                renderConfigReview(detectedServerConfig);
                showAddServerStep(2);
            } catch (error) {
                showMessage('Detection failed: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Detect';
            }
        }

        function renderConfigReview(config) {
            // Show/hide Infisical warning
            document.getElementById('infisicalWarning').style.display =
                (!infisicalConfigured && config.required_env_vars && config.required_env_vars.length > 0)
                    ? 'block' : 'none';

            // Render detected config fields
            const detectedFrom = config.detected_from ?
                `<span class="detected-badge">Detected from ${config.detected_from}</span>` : '';

            document.getElementById('detectedConfig').innerHTML = `
                <div class="config-field">
                    <label>Server Name ${detectedFrom}</label>
                    <input type="text" id="serverName" value="${config.name || ''}">
                </div>
                <div class="config-field">
                    <label>Description</label>
                    <input type="text" id="serverDesc" value="${config.description || ''}">
                </div>
                <div class="config-field">
                    <label>Docker Image</label>
                    <input type="text" id="serverImage" value="${config.image || ''}"
                           placeholder="e.g., ghcr.io/org/server:latest or oven/bun:1">
                </div>
                <div class="config-field">
                    <label>Command</label>
                    <input type="text" id="serverCommand" value="${(config.command || []).join(' ')}"
                           placeholder="e.g., node dist/index.js stdio">
                </div>
            `;

            // Render required args inputs if present
            const argsSection = document.getElementById('requiredArgsSection');
            const argsInputs = document.getElementById('requiredArgsInputs');

            if (config.required_args && config.required_args.length > 0) {
                argsSection.style.display = 'block';
                argsInputs.innerHTML = config.required_args.map(arg => `
                    <div class="env-var-input">
                        <label>${arg.description || arg.name}</label>
                        <input type="text" id="arg-${arg.name}" placeholder="${arg.placeholder || ''}"
                               data-arg-name="${arg.name}">
                    </div>
                `).join('');
            } else {
                argsSection.style.display = 'none';
                argsInputs.innerHTML = '';
            }

            // Render env var inputs if required
            const envSection = document.getElementById('envVarsSection');
            const envInputs = document.getElementById('envVarInputs');

            if (config.required_env_vars && config.required_env_vars.length > 0) {
                envSection.style.display = 'block';
                envInputs.innerHTML = config.required_env_vars.map(v => `
                    <div class="env-var-input">
                        <label>${v}</label>
                        <input type="password" id="env-${v}" placeholder="Enter value for ${v}">
                    </div>
                `).join('');
            } else {
                envSection.style.display = 'none';
                envInputs.innerHTML = '';
            }
        }

        async function provisionServer() {
            const name = document.getElementById('serverName').value.trim();
            const description = document.getElementById('serverDesc').value.trim();
            const image = document.getElementById('serverImage').value.trim();
            const commandStr = document.getElementById('serverCommand').value.trim();
            let command = commandStr ? commandStr.split(/\s+/).filter(s => s) : [];

            // Collect required args and append to command
            if (detectedServerConfig && detectedServerConfig.required_args) {
                for (const arg of detectedServerConfig.required_args) {
                    const input = document.getElementById(`arg-${arg.name}`);
                    if (input && input.value.trim()) {
                        command.push(input.value.trim());
                    }
                }
            }

            if (!name) {
                showMessage('Server name is required', 'error');
                return;
            }
            if (!image) {
                showMessage('Docker image is required', 'error');
                return;
            }

            // Collect env vars
            const envVars = {};
            if (detectedServerConfig && detectedServerConfig.required_env_vars) {
                for (const v of detectedServerConfig.required_env_vars) {
                    const input = document.getElementById(`env-${v}`);
                    if (input && input.value) {
                        envVars[v] = input.value;
                    }
                }
            }

            // Show progress step
            showAddServerStep(3);
            resetProgressIndicators();

            // Simulate progress (actual progress happens server-side)
            setProgressState('prog-secrets', 'active');

            try {
                const response = await fetch('/api/servers/provision', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, image, command, env_vars: envVars })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                // Mark all as done
                ['prog-secrets', 'prog-compose', 'prog-config', 'prog-start', 'prog-verify'].forEach(id => {
                    setProgressState(id, 'done');
                });

                // Show success (with optional warning about container status)
                const hasWarning = data.warning || !data.container_running;
                document.getElementById('resultContent').innerHTML = `
                    <div class="result-success">
                        <div class="icon">${hasWarning ? '⚠' : '✓'}</div>
                        <h3>Server Added${hasWarning ? ' (with warning)' : ''}!</h3>
                        <p>Server <strong>${data.name}</strong> has been configured.</p>
                        <p>Container status: <strong style="color: ${data.container_running ? '#28a745' : '#dc3545'}">${data.container_status || 'unknown'}</strong></p>
                        <p>Tools discovered: <strong>${data.tool_count}</strong></p>
                        ${data.warning ? `<p style="color: #856404; font-size: 13px;">${data.warning}</p>` : ''}
                        ${data.tool_count === 0 && data.container_running ? '<p style="color: #666; font-size: 13px;">Tools may appear after a page refresh.</p>' : ''}
                        ${!data.infisical_configured && Object.keys(envVars).length > 0 ?
                            '<p style="color: #856404; font-size: 13px;">Remember to add secrets to your .env file and restart.</p>' : ''}
                    </div>
                `;
                showAddServerStep(4);
                loadServers();

            } catch (error) {
                // Mark failed
                setProgressState('prog-secrets', 'error');

                document.getElementById('resultContent').innerHTML = `
                    <div class="result-error">
                        <div class="icon">✗</div>
                        <h3>Provisioning Failed</h3>
                        <p class="error-message">${error.message}</p>
                        <p style="color: #666; font-size: 13px;">Check the server logs for more details.</p>
                    </div>
                `;
                showAddServerStep(4);
            }
        }

        // =====================================================================
        // Server Management
        // =====================================================================

        async function loadServers() {
            try {
                const response = await fetch('/api/servers');
                const data = await response.json();

                if (!data.success) return;

                const list = document.getElementById('serversList');

                if (data.servers.length === 0) {
                    list.innerHTML = '<p style="color: #666; font-style: italic;">No servers configured.</p>';
                    return;
                }

                list.innerHTML = data.servers.map(server => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: white; border-radius: 4px; margin-bottom: 8px; border: 1px solid #e9ecef;">
                        <div>
                            <strong style="color: #333;">${server.name}</strong>
                            <span style="margin-left: 10px; font-size: 12px; color: ${server.running ? '#28a745' : '#dc3545'};">
                                ${server.running ? 'Running' : 'Stopped'}
                            </span>
                            <span style="margin-left: 10px; font-size: 12px; color: #666;">
                                ${server.tool_count} tools
                            </span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="restartServer('${server.name}')"
                                style="padding: 5px 12px; background: #ffc107; color: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                Restart
                            </button>
                            <button onclick="deleteServer('${server.name}')"
                                style="padding: 5px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                Remove
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load servers', e);
            }
        }

        async function deleteServer(name) {
            if (!confirm(`Remove server '${name}'? This will stop the container and delete the config.`)) return;

            try {
                const response = await fetch(`/api/servers/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    showMessage(`Server '${name}' removed`, 'success');
                    loadServers();
                    loadTools();  // Refresh tools list
                } else {
                    showMessage('Error removing server: ' + data.error, 'error');
                }
            } catch (e) {
                showMessage('Error removing server: ' + e.message, 'error');
            }
        }

        async function restartServer(name) {
            try {
                const response = await fetch(`/api/servers/${encodeURIComponent(name)}/restart`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    showMessage(`Server '${name}' restarted`, 'success');
                    loadServers();
                } else {
                    showMessage('Error restarting server: ' + data.error, 'error');
                }
            } catch (e) {
                showMessage('Error restarting server: ' + e.message, 'error');
            }
        }

        // Load tools on page load
        loadTools();
        loadServers();
    </script>
</body>

</html>
